OBJDIRS += tests

TESTS_SRCFILES := \
		src/tests/server.cc \
		src/tests/backup.cc \
		src/tests/hashtable.cc \
		src/tests/tests.cc

TESTS_OBJFILES := $(TESTS_SRCFILES)
TESTS_OBJFILES := $(patsubst src/tests/%.c, $(OBJDIR)/tests/%.o, $(TESTS_OBJFILES))
TESTS_OBJFILES := $(patsubst src/tests/%.cc, $(OBJDIR)/tests/%.o, $(TESTS_OBJFILES))
TESTS_OBJFILES := $(TESTS_OBJFILES) \
               $(SHARED_OBJFILES) \
               $(SERVER_OBJFILES) \
               $(BACKUP_OBJFILES)

TESTS_LIB := -lcppunit -ldl

$(OBJDIR)/tests/tests: $(TESTS_OBJFILES)
	@mkdir -p $(@D)
	$(CXX) $(TESTS_LIB) -o $@ $^

$(OBJDIR)/tests/%.o: $(TOP)/src/tests/%.c
	@mkdir -p $(@D)
	$(CC) $(CFLAGS) -c -o $@ $<

$(OBJDIR)/tests/%.o: $(TOP)/src/tests/%.cc
	@mkdir -p $(@D)
	$(CXX) $(CXXFLAGS) -c -o $@ $<

test: $(OBJDIR)/tests/tests
	$(OBJDIR)/tests/tests
