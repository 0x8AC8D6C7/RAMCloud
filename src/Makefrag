OBJDIRS += $(OBJDIR)

ifeq ($(INFINIBAND),yes)
INFINIBAND_SRCFILES := \
           src/InfRCTransport.cc \
           $(NULL)
else
INFINIBAND_SRCFILES :=
endif

SHARED_SRCFILES := \
		   src/Client.cc \
		   src/ClientException.cc \
		   src/Coordinator.cc \
		   src/BackupClient.cc \
		   src/BenchUtil.cc \
		   src/Buffer.cc \
		   src/Common.cc \
		   src/Driver.cc \
		   src/FastTransport.cc \
		   src/IpAddress.cc \
		   src/Log.cc \
		   src/Logging.cc \
		   src/OptionParser.cc \
		   src/Pool.cc \
		   src/Segment.cc \
		   src/ServiceLocator.cc \
		   src/StringConverter.cc \
		   src/Status.cc \
		   src/TcpTransport.cc \
		   src/Table.cc \
		   src/TransportManager.cc \
		   src/UdpDriver.cc \
		   src/rabinpoly.cc \
           $(INFINIBAND_SRCFILES) \
		   $(NULL)

SHARED_OBJFILES := $(SHARED_SRCFILES)
SHARED_OBJFILES := $(patsubst src/%.cc, $(OBJDIR)/%.o, $(SHARED_OBJFILES))

$(TOP)/src/config.h:
	cp $(TOP)/src/config.h.tmpl $@

$(OBJDIR)/%.o: $(TOP)/src/%.cc $(TOP)/src/config.h
	@mkdir -p $(@D)
	$(call run-cxx,$@,$<, -fPIC)

# If there's a cc file in the object dir, build it.
# This is for auto-generated source code.
$(OBJDIR)/%.o: $(OBJDIR)/%.cc $(TOP)/src/config.h
	@mkdir -p $(@D)
	$(call run-cxx,$@,$<, -fPIC)

all: $(TOP)/src/config.h
