OBJDIRS += $(OBJDIR)

AUTO_GEN_HEADERS := $(patsubst src/%.proto, $(OBJDIR)/%.pb.h, $(wildcard src/*.proto))
AUTO_GEN_HEADERS += $(OBJDIR)/Metrics.in.h
.SECONDARY: $(AUTO_GEN_HEADERS)
$(OBJDIR)/%.pb.cc $(OBJDIR)/%.pb.h: $(TOP)/src/%.proto
	@mkdir -p $(OBJDIR)
	@echo protoc ... $$(basename $<)
	@cd $(TOP)/src/; \
	protoc --cpp_out=$(TOP)/$(OBJDIR) $$(basename $<); \
	echo "// RAMCloud pragma [GCCWARN=0]" >> $(TOP)/$(OBJDIR)/$$(basename $< .proto).pb.h; \
	echo "// RAMCloud pragma [GCCWARN=0]" >> $(TOP)/$(OBJDIR)/$$(basename $< .proto).pb.cc


ifeq ($(INFINIBAND),yes)
INFINIBAND_SRCFILES := \
	   src/Infiniband.cc \
	   src/InfRcTransport.cc \
	   src/InfUdDriver.cc \
	   $(NULL)
else
INFINIBAND_SRCFILES :=
endif

# these files are compiled into everything but clients
SHARED_SRCFILES := \
		   src/Client.cc \
		   src/ClientException.cc \
		   src/CoordinatorClient.cc \
		   src/Crc32C.cc \
		   src/BackupClient.cc \
		   src/BackupManager.cc \
		   src/BenchUtil.cc \
		   src/Buffer.cc \
		   src/ClientException.cc \
		   src/Common.cc \
		   src/Dispatch.cc \
		   src/Driver.cc \
		   src/FastTransport.cc \
		   src/FailureDetector.cc \
		   src/IpAddress.cc \
		   src/Log.cc \
		   src/LogCleaner.cc \
		   src/Logging.cc \
		   src/MacAddress.cc \
		   src/MasterClient.cc \
		   src/MasterService.cc \
		   src/Metrics.cc \
		   src/ObjectFinder.cc \
		   src/OptionParser.cc \
		   src/RamCloud.cc \
		   src/Recovery.cc \
		   src/RecoverySegmentIterator.cc \
		   src/Segment.cc \
		   src/SegmentIterator.cc \
		   src/Service.cc \
		   src/ServiceLocator.cc \
		   src/ServiceManager.cc \
		   src/Status.cc \
		   src/StringKeyAdapter.cc \
		   src/TabletProfiler.cc \
		   src/TcpTransport.cc \
		   src/ThreadId.cc \
		   src/TimeCounter.cc \
		   src/Transport.cc \
		   src/TransportManager.cc \
		   src/UdpDriver.cc \
		   src/UnreliableTransport.cc \
		   src/Will.cc \
		   $(INFINIBAND_SRCFILES) \
		   $(OBJDIR)/ServerList.pb.cc \
		   $(OBJDIR)/Tablets.pb.cc \
		   $(NULL)

SHARED_OBJFILES := $(SHARED_SRCFILES)
SHARED_OBJFILES := $(patsubst src/%.cc, $(OBJDIR)/%.o, $(SHARED_OBJFILES))
SHARED_OBJFILES := $(patsubst $(OBJDIR)/%.cc, $(OBJDIR)/%.o, $(SHARED_OBJFILES))

$(OBJDIR)/%.o: $(TOP)/src/%.cc $(AUTO_GEN_HEADERS)
	@mkdir -p $(@D)
	$(call run-cxx,$@,$<, -fPIC)

# If there's a cc file in the object dir, build it.
# This is for auto-generated source code.
$(OBJDIR)/%.o: $(OBJDIR)/%.cc $(AUTO_GEN_HEADERS)
	@mkdir -p $(@D)
	$(call run-cxx,$@,$<, -fPIC)

$(OBJDIR)/Metrics.in.cc  $(OBJDIR)/Metrics.in.h: $(TOP)/scripts/metrics.py
	$(TOP)/scripts/metrics.py --build-only

all:
